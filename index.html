<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Lista de Compras Consolidada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-pink': '#FF4FB6',
                        'custom-yellow': '#FFD166',
                        'custom-pink-light': '#FFE4F5',
                        'custom-yellow-light': '#FFF5D6',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-input { display: none; }
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .tab-btn.active {
            background-color: #FFD166;
            color: #1f2937;
            border-color: #FFD166;
        }
        .tab-btn:not(.active) {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-6">
        <!-- Cabeçalho -->
        <div class="flex items-center justify-between gap-4">
            <img id="logo-img" class="hidden h-16 w-auto" src="" alt="Logo da Empresa">
            <div class="text-right flex-grow">
                <h1 class="text-3xl font-bold text-custom-pink">Lista de Compras Consolidada</h1>
                <p class="mt-1 text-md font-semibold" style="color: #FFD166;">Agrupado por Produto e Sabor!</p>
            </div>
        </div>

        <!-- Área de Upload -->
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center space-y-4">
             <div>
                <label for="logo-file" class="text-sm font-medium text-gray-700">Carregar Logo (Opcional):</label>
                <input id="logo-file" type="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-custom-pink-light file:text-custom-pink hover:file:bg-custom-pink/20" accept="image/png, image/jpeg">
            </div>
            <label for="excel-file" class="inline-flex items-center justify-center cursor-pointer py-3 px-6 rounded-lg font-semibold transition-all bg-custom-yellow text-gray-800 hover:bg-custom-pink hover:text-white">
                 <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0A2.25 2.25 0 015.625 7.5h12.75a2.25 2.25 0 012.25 2.25m-16.5 0v-1.5c0-.621.504-1.125 1.125-1.125h14.25c.621 0 1.125.504 1.125 1.125v1.5"/></svg>
                <span>Carregar Planilha Excel</span>
            </label>
            <input id="excel-file" type="file" class="file-input" accept=".xlsx, .xls">
            <p id="file-name" class="text-sm text-gray-500">Nenhum arquivo selecionado</p>
            <button id="generate-btn" class="w-full md:w-auto bg-custom-pink text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-custom-yellow hover:text-gray-800 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Gerar XLSX Consolidado
            </button>
        </div>

        <!-- Log e Resumo -->
        <div id="log-summary" class="hidden space-y-3"></div>

        <!-- Prévia da Tabela com Abas -->
        <div id="preview-section" class="hidden">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button id="tab-btn-details" class="tab-btn active" data-tab="details">Itens Consolidados</button>
                    <button id="tab-btn-summary" class="tab-btn" data-tab="summary">Resumo por Produto</button>
                </nav>
            </div>
            
            <div id="tab-content-details" class="tab-content active mt-4">
                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-custom-yellow">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Produto (Família/Marca)</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Sabor / Variação</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Quantidade Total</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body-details" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-content-summary" class="tab-content mt-4">
                 <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-custom-yellow">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Produto</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Sabor / Variação</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body-summary" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <button id="download-btn" class="mt-6 w-full md:w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                Download da Lista (XLSX)
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos da UI
            const fileInput = document.getElementById('excel-file');
            const fileNameDisplay = document.getElementById('file-name');
            const generateBtn = document.getElementById('generate-btn');
            const logSummaryDiv = document.getElementById('log-summary');
            const previewSection = document.getElementById('preview-section');
            const downloadBtn = document.getElementById('download-btn');
            const logoInput = document.getElementById('logo-file');
            const logoImg = document.getElementById('logo-img');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            let finalData = [];

            // --- LÓGICA DE NEGÓCIO ---

            // Dicionário de Mapeamento de Família/Marca (Fácil de editar)
            // Convertido para array para garantir a ordem da verificação
            const PRODUCT_FAMILY_MAP_ARRAY = [
                ['elma chips', 'Salgadinho Elma Chips'],
                ['m&m', 'Chocolate M&M\'s'],
                ['m’s sachê', 'Chocolate M&M\'s'],
                ['chocolate m', 'Chocolate M&M\'s'],
                ['papermint', 'Papermint'],
                ['bauducco', 'Bauducco'],
                ['fini', 'Bala Fini'],
                ['dociles', 'Bala Fini']
                // Adicione mais mapeamentos aqui, os mais específicos primeiro
            ];
            
            // Palavras a serem ignoradas ao dividir kits
            const KIT_IGNORE_PARTIAL_MATCH = ['espátula', 'leiteira'];
            const KIT_IGNORE_EXACT_MATCH = ['g'];

            const identifyProductFamily = (name, warnings) => {
                const nameLower = name.toLowerCase();
                for (const [key, family] of PRODUCT_FAMILY_MAP_ARRAY) {
                    if (nameLower.includes(key)) {
                        return family;
                    }
                }
                // Fallback: limpa o nome e usa como família
                let cleanedName = name.replace(/\b(kit|pacote(s)?|unidade(s)?|combo|cx|display|x|–.*?cada)\b/gi, '').replace(/\s\s+/g, ' ').trim();
                // Aviso de família não mapeada removido a pedido do usuário.
                return cleanedName || 'Produto Desconhecido';
            };

            const normalizeVariationStrict = (variation) => {
                const v = String(variation).trim();
                return v.toLowerCase() === 'variado' ? 'variado' : v;
            };

            const formatForDisplay = (str, isSabor = false) => {
                const s = String(str).trim();
                if (isSabor) {
                    if (s.toLowerCase() === 'variado') return 'variado';
                    if (s === '') return '(Vazio)';
                }
                if (s === '') return '(Não especificado)';
                // A referência ao mapa antigo foi removida para corrigir um bug e simplificar a capitalização.
                return s.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            };

            const getColumnValues = (row, warnings) => {
                const keys = Object.keys(row);
                const findKey = (synonyms) => keys.find(k => synonyms.some(s => k.toLowerCase().trim().replace(/ç|ã/g, c => ({'ç':'c', 'ã':'a'})[c]).includes(s)));
                const nameKey = findKey(['produto', 'nome do produto']);
                const quantityKey = findKey(['quantidade', 'qtd']);
                const variationKey = findKey(['variacao', 'variação', 'sabor']);
                if (!nameKey) warnings.add('Coluna de "Produto" não encontrada.');
                if (!quantityKey) warnings.add('Coluna de "Quantidade" não encontrada.');
                return { name: row[nameKey] || '', quantity: row[quantityKey] || 0, variation: row[variationKey] || '' };
            };

            const processData = (data) => {
                let intermediateData = [];
                let linesRead = 0, kitsDetected = 0, componentsProcessed = 0, nonKitItems = 0;
                const warnings = new Set();

                data.forEach((row, index) => {
                    const { name, quantity, variation } = getColumnValues(row, warnings);
                    if (!name && !quantity && !variation) return;
                    linesRead++;

                    const baseQuantity = parseInt(String(quantity).replace(",", "."), 10) || 0;
                    if (isNaN(baseQuantity) || baseQuantity < 0) {
                        warnings.add(`Linha ${index + 2}: Quantidade inválida ('${quantity}'). Ignorado.`);
                        return;
                    }
                    
                    const normalizedVar = normalizeVariationStrict(variation);
                    
                    const kitSeparators = /\s*(\+|,|&|mais)\s*/i;
                    const nameStr = String(name);
                    
                    if (kitSeparators.test(nameStr)) {
                        kitsDetected++;
                        const components = nameStr.split(kitSeparators)
                            .map(c => c.trim())
                            .filter(c => {
                                if (!c || kitSeparators.test(c)) return false;
                                const lowerC = c.toLowerCase();
                                if (KIT_IGNORE_EXACT_MATCH.includes(lowerC)) return false;
                                if (KIT_IGNORE_PARTIAL_MATCH.some(part => lowerC.includes(part))) return false;
                                return true;
                            });
                        
                        components.forEach(itemStr => {
                            let itemQuantity = 1;
                            const match = itemStr.trim().match(/^(\d+)\s*(.*)/);
                            let productText = itemStr.trim(); // Assume que não há número inicialmente
                            
                            if (match) {
                                itemQuantity = parseInt(match[1], 10);
                                productText = match[2].trim();
                            }
                            
                            // IGNORA componentes de 1 letra (como "G") ou vazios
                            if (productText.length <= 1) {
                                return; // Pula para o próximo componente
                            }

                            const productName = identifyProductFamily(productText, warnings);
                            intermediateData.push({ produto: productName, sabor: normalizedVar, quantidade: itemQuantity * (baseQuantity || 1) });
                           
                            componentsProcessed++;
                        });

                    } else if (nameStr.toLowerCase().includes('kit') || nameStr.toLowerCase().includes('display')) {
                        kitsDetected++;
                        let multiplier = 1;
                        const kitMatch = nameStr.match(/(kit|display)\s*(\d+)/i);
                         if (kitMatch && kitMatch[2]) multiplier = parseInt(kitMatch[2], 10);
                         // Não gera mais aviso para multiplicador assumido
                        
                        const productName = identifyProductFamily(nameStr, warnings);
                        intermediateData.push({ produto: productName, sabor: normalizedVar, quantidade: multiplier * baseQuantity });
                        componentsProcessed++;
                    
                    } else {
                        nonKitItems++;
                        const productName = identifyProductFamily(nameStr, warnings);
                        intermediateData.push({ produto: productName, sabor: normalizedVar, quantidade: baseQuantity });
                    }
                });

                const groupedData = new Map();
                intermediateData.forEach(item => {
                    const key = `${item.produto.toLowerCase()}|${item.sabor.trim().toLowerCase()}`;
                    if (groupedData.has(key)) {
                        groupedData.get(key).quantidade += item.quantidade;
                    } else {
                        groupedData.set(key, { ...item });
                    }
                });
                
                finalData = Array.from(groupedData.values()).filter(item => item.quantidade > 0);
                
                updateLog(linesRead, kitsDetected, componentsProcessed, nonKitItems, finalData.length, warnings);
                renderPreview();
            };

            // --- LÓGICA DE UI E EVENTOS ---

            logoInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    logoImg.src = URL.createObjectURL(e.target.files[0]);
                    logoImg.classList.remove('hidden');
                }
            });

            fileInput.addEventListener('change', (e) => {
                fileNameDisplay.textContent = e.target.files.length > 0 ? e.target.files[0].name : 'Nenhum arquivo selecionado';
                generateBtn.disabled = e.target.files.length === 0;
            });
            
            generateBtn.addEventListener('click', () => {
                const file = fileInput.files[0];
                if (!file) return;

                logSummaryDiv.innerHTML = '';
                logSummaryDiv.classList.add('hidden');
                previewSection.classList.add('hidden');
                generateBtn.textContent = 'Processando...';
                generateBtn.disabled = true;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        processData(XLSX.utils.sheet_to_json(worksheet, { defval: "" }));
                    } catch (error) {
                         updateLog(0,0,0,0,0, new Set([`Erro fatal: ${error.message}`]));
                    } finally {
                        generateBtn.textContent = 'Gerar XLSX Consolidado';
                        generateBtn.disabled = false;
                    }
                };
                reader.onerror = (error) => {
                    updateLog(0,0,0,0,0, new Set([`Erro ao ler o arquivo: ${error}`]));
                    generateBtn.textContent = 'Gerar XLSX Consolidado';
                    generateBtn.disabled = false;
                };
                reader.readAsArrayBuffer(file);
            });
            
            downloadBtn.addEventListener('click', () => {
                if (finalData.length === 0) return;

                const wb = XLSX.utils.book_new();

                // Aba 1: Itens Consolidados
                const dataToExportDetails = finalData.sort((a,b) => a.produto.localeCompare(b.produto) || a.sabor.localeCompare(b.sabor)).map(item => ({
                    produto: formatForDisplay(item.produto),
                    sabor: formatForDisplay(item.sabor, true),
                    quantidade: item.quantidade
                }));
                const wsDetails = XLSX.utils.json_to_sheet(dataToExportDetails);
                XLSX.utils.book_append_sheet(wb, wsDetails, 'Itens Consolidados');

                // Aba 2: Resumo
                const summaryData = [];
                const productsSummary = finalData.reduce((acc, item) => {
                    acc[item.produto] = (acc[item.produto] || 0) + item.quantidade;
                    return acc;
                }, {});

                Object.keys(productsSummary).sort().forEach(prod => {
                    finalData.filter(i => i.produto === prod).sort((a,b) => a.sabor.localeCompare(b.sabor)).forEach(item => {
                        summaryData.push({
                            'Produto': formatForDisplay(item.produto),
                            'Sabor / Variação': formatForDisplay(item.sabor, true),
                            'Subtotal': item.quantidade
                        });
                    });
                    summaryData.push({
                        'Produto': formatForDisplay(prod),
                        'Sabor / Variação': '--- TOTAL ---',
                        'Subtotal': productsSummary[prod]
                    });
                });
                const wsSummary = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumo');

                XLSX.writeFile(wb, 'lista_consolidada.xlsx');
            });

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    tabContents.forEach(content => {
                        content.classList.toggle('active', content.id === `tab-content-${button.dataset.tab}`);
                    });
                });
            });

            const updateLog = (lines, kits, components, nonKits, finalCount, warnings) => {
                logSummaryDiv.innerHTML = '';
                const successMsg = `<strong>Processamento Concluído!</strong>
                    <ul class="list-disc list-inside mt-2 text-sm">
                        <li><strong>${lines}</strong> linhas lidas.</li>
                        <li><strong>${kits}</strong> kits detectados (${components} componentes).</li>
                        <li><strong>${nonKits}</strong> itens simples processados.</li>
                        <li><strong>${finalCount}</strong> linhas únicas na lista final.</li>
                    </ul>`;
                const successEntry = document.createElement('div');
                successEntry.className = `border-l-4 p-4 rounded-md bg-custom-yellow-light border-custom-yellow text-yellow-800`;
                successEntry.innerHTML = successMsg;
                logSummaryDiv.appendChild(successEntry);
                
                if (warnings.size > 0) {
                    const warningList = Array.from(warnings).map(w => `<li class="ml-4 list-disc">${w}</li>`).join('');
                    const warningEntry = document.createElement('div');
                    warningEntry.className = 'border-l-4 p-4 rounded-md bg-custom-pink-light border-custom-pink text-pink-800';
                    warningEntry.innerHTML = `<strong>Avisos (${warnings.size}):</strong><ul class="text-sm">${warningList}</ul>`;
                    logSummaryDiv.appendChild(warningEntry);
                }
                logSummaryDiv.classList.remove('hidden');
            };

            const renderPreview = () => {
                if(finalData.length === 0) {
                    previewSection.classList.add('hidden');
                    return;
                }
                const detailsBody = document.getElementById('preview-table-body-details');
                const summaryBody = document.getElementById('preview-table-body-summary');
                detailsBody.innerHTML = '';
                summaryBody.innerHTML = '';
                
                // Render Details Tab
                finalData.sort((a,b) => a.produto.localeCompare(b.produto) || a.sabor.localeCompare(b.sabor)).forEach((item, index) => {
                    const row = detailsBody.insertRow();
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatForDisplay(item.produto)}</td>
                                     <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatForDisplay(item.sabor, true)}</td>
                                     <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-bold">${item.quantidade}</td>`;
                });

                // Render Summary Tab
                const productsSummary = finalData.reduce((acc, item) => {
                    if (!acc[item.produto]) acc[item.produto] = 0;
                    acc[item.produto] += item.quantidade;
                    return acc;
                }, {});

                Object.keys(productsSummary).sort().forEach(prod => {
                    const itemsForProd = finalData.filter(i => i.produto === prod).sort((a,b) => a.sabor.localeCompare(b.sabor));
                    itemsForProd.forEach((item, index) => {
                        const row = summaryBody.insertRow();
                        row.className = index === 0 ? 'border-t-2 border-gray-300' : '';
                        row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index === 0 ? formatForDisplay(prod) : ''}</td>
                                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatForDisplay(item.sabor, true)}</td>
                                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item.quantidade}</td>`;
                    });
                    const totalRow = summaryBody.insertRow();
                    totalRow.className = 'bg-gray-100 font-bold';
                    totalRow.innerHTML = `<td class="px-6 py-4 text-right text-sm" colspan="2">Total para ${formatForDisplay(prod)}</td>
                                          <td class="px-6 py-4 text-sm">${productsSummary[prod]}</td>`;
                });

                previewSection.classList.remove('hidden');
                document.getElementById('tab-btn-details').click();
            };

        });
    </script>
</body>
</html>




